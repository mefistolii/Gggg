<!DOCTYPE html>
<html>
<head>
<title>VideoSync</title>
<meta charset="UTF-8">
<style>
body { font-family: Arial; max-width: 800px; margin: 0 auto; padding: 20px; }
.hidden { display: none; }
input, button { width: 100%; padding: 10px; margin: 5px 0; }
button { background: #4CAF50; color: white; border: none; cursor: pointer; }
#roomInfo { background: #e8f5e9; padding: 10px; margin: 10px 0; }
#videoFrame { width: 100%; height: 400px; margin: 10px 0; }
.timer { font-size: 24px; font-family: monospace; margin: 10px 0; }
.status { padding: 10px; margin: 10px 0; }
.success { background: #d4edda; }
.error { background: #f8d7da; }
</style>
</head>
<body>

<h1>VideoSync</h1>

<div id="mainScreen">
    <h3>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</h3>
    <input type="text" id="hostName" placeholder="–í–∞—à–µ –∏–º—è">
    <button onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É (—Å—Ç–∞—Ç—å —Ö–æ—Å—Ç–æ–º)</button>
    
    <h3>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ</h3>
    <input type="text" id="roomIdInput" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã">
    <input type="text" id="guestName" placeholder="–í–∞—à–µ –∏–º—è">
    <button onclick="joinRoom()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
</div>

<div id="roomScreen" class="hidden">
    <div id="roomInfo">
        <strong>–ö–æ–º–Ω–∞—Ç–∞:</strong> <span id="roomName"></span><br>
        <strong>ID:</strong> <span id="roomId"></span><br>
        <strong>–í–∞—à–∞ —Ä–æ–ª—å:</strong> <span id="userRole"></span>
        <button onclick="copyLink()" style="width:auto; float:right;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
    </div>
    
    <div id="hostControls" class="hidden">
        <div class="timer">–¢–∞–π–º–µ—Ä —Ö–æ—Å—Ç–∞: <span id="hostTimer">00:00:00</span></div>
        <div>
            <button onclick="startTimer()" id="startBtn">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç —Ç–∞–π–º–µ—Ä–∞</button>
            <button onclick="pauseTimer()" id="pauseBtn" class="hidden">‚è∏Ô∏è –ü–∞—É–∑–∞</button>
            <button onclick="resetTimer()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
        
        <h4>–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ:</h4>
        <input type="text" id="videoUrl" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ VK/YouTube –≤–∏–¥–µ–æ">
        <button onclick="loadVideo()">üì∫ –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</button>
    </div>
    
    <div id="guestControls" class="hidden">
        <button onclick="syncWithHost()" class="sync-btn">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å —Ö–æ—Å—Ç–æ–º</button>
        <p>–¢–∞–π–º–µ—Ä —Ö–æ—Å—Ç–∞: <span id="guestTimer">00:00:00</span></p>
    </div>
    
    <iframe id="videoFrame" allowfullscreen></iframe>
    
    <button onclick="leaveRoom()" class="leave-btn">üö™ –í—ã–π—Ç–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã</button>
</div>

<div id="status" class="status"></div>

<script>
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
const API_URL = 'https://video.prohorverbovec.workers.dev';

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentRoom = null;
let isHost = false;
let timer = 0;
let timerInterval = null;
let userId = 'user_' + Date.now();

// –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
function showStatus(text, type) {
    const el = document.getElementById('status');
    el.textContent = text;
    el.className = 'status ' + type;
    setTimeout(() => el.textContent = '', 3000);
}

// –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
async function createRoom() {
    const name = document.getElementById('hostName').value.trim() || '–•–æ—Å—Ç';
    
    try {
        const response = await fetch(API_URL + '/api/rooms', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({hostName: name, hostId: userId})
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentRoom = data.room;
            isHost = true;
            showRoom();
            showStatus('–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞! ID: ' + currentRoom.id, 'success');
        }
    } catch (e) {
        showStatus('–û—à–∏–±–∫–∞: ' + e.message, 'error');
    }
}

// –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
async function joinRoom() {
    const roomId = document.getElementById('roomIdInput').value.trim().toUpperCase();
    const name = document.getElementById('guestName').value.trim() || '–ì–æ—Å—Ç—å';
    
    if (!roomId) return showStatus('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã', 'error');
    
    try {
        const response = await fetch(API_URL + '/api/room/' + roomId);
        const data = await response.json();
        
        if (data.success && data.room) {
            currentRoom = data.room;
            isHost = false;
            showRoom();
            showStatus('–í—ã –≤ –∫–æ–º–Ω–∞—Ç–µ –∫–∞–∫ ' + name, 'success');
        } else {
            showStatus('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
        }
    } catch (e) {
        showStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
function showRoom() {
    document.getElementById('mainScreen').classList.add('hidden');
    document.getElementById('roomScreen').classList.remove('hidden');
    
    document.getElementById('roomName').textContent = currentRoom.host_name;
    document.getElementById('roomId').textContent = currentRoom.id;
    
    if (isHost) {
        document.getElementById('userRole').textContent = 'üëë –•–û–°–¢';
        document.getElementById('hostControls').classList.remove('hidden');
        document.getElementById('guestControls').classList.add('hidden');
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        timer = currentRoom.host_timer || 0;
        updateTimerDisplay('hostTimer');
        
        if (currentRoom.is_timer_running) {
            startTimer();
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ
        if (currentRoom.video_url) {
            loadVideoFromUrl(currentRoom.video_url);
        }
    } else {
        document.getElementById('userRole').textContent = 'üë§ –ó–†–ò–¢–ï–õ–¨';
        document.getElementById('hostControls').classList.add('hidden');
        document.getElementById('guestControls').classList.remove('hidden');
        
        updateGuestTimer();
        
        if (currentRoom.video_url) {
            loadVideoFromUrl(currentRoom.video_url);
        }
    }
}

// –¢–∞–π–º–µ—Ä —Ö–æ—Å—Ç–∞
function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    
    timerInterval = setInterval(async () => {
        timer++;
        updateTimerDisplay('hostTimer');
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ D1
        await fetch(API_URL + '/api/room/' + currentRoom.id + '/timer', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({timer: timer, isRunning: true})
        });
    }, 1000);
    
    document.getElementById('startBtn').classList.add('hidden');
    document.getElementById('pauseBtn').classList.remove('hidden');
}

function pauseTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
        
        fetch(API_URL + '/api/room/' + currentRoom.id + '/timer', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({timer: timer, isRunning: false})
        });
        
        document.getElementById('startBtn').classList.remove('hidden');
        document.getElementById('pauseBtn').classList.add('hidden');
    }
}

function resetTimer() {
    pauseTimer();
    timer = 0;
    updateTimerDisplay('hostTimer');
    
    fetch(API_URL + '/api/room/' + currentRoom.id + '/timer', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({timer: 0, isRunning: false})
    });
    
    showStatus('–¢–∞–π–º–µ—Ä —Å–±—Ä–æ—à–µ–Ω', 'success');
}

function updateTimerDisplay(elementId) {
    const h = Math.floor(timer / 3600);
    const m = Math.floor((timer % 3600) / 60);
    const s = timer % 60;
    document.getElementById(elementId).textContent = 
        h.toString().padStart(2, '0') + ':' + 
        m.toString().padStart(2, '0') + ':' + 
        s.toString().padStart(2, '0');
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ
async function loadVideo() {
    const url = document.getElementById('videoUrl').value.trim();
    if (!url) return showStatus('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É', 'error');
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –ø—Ä–∏ —Å–º–µ–Ω–µ –≤–∏–¥–µ–æ
    if (isHost) {
        resetTimer();
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ D1
    await fetch(API_URL + '/api/room/' + currentRoom.id + '/video', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({videoUrl: url})
    });
    
    loadVideoFromUrl(url);
    showStatus('–í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
}

function loadVideoFromUrl(url) {
    const frame = document.getElementById('videoFrame');
    
    if (url.includes('vk.com')) {
        let params = url.includes('?') ? url.split('?')[1] : '';
        frame.src = 'https://vk.com/video_ext.php?' + params;
    } else if (url.includes('youtube.com') || url.includes('youtu.be')) {
        let videoId = '';
        if (url.includes('youtube.com/watch?v=')) {
            videoId = url.split('v=')[1].split('&')[0];
        } else if (url.includes('youtu.be/')) {
            videoId = url.split('youtu.be/')[1].split('?')[0];
        }
        frame.src = 'https://www.youtube.com/embed/' + videoId;
    } else {
        frame.src = url;
    }
}

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
async function syncWithHost() {
    try {
        const response = await fetch(API_URL + '/api/room/' + currentRoom.id);
        const data = await response.json();
        
        if (data.success) {
            currentRoom = data.room;
            updateGuestTimer();
            showStatus('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ! –¢–∞–π–º–µ—Ä: ' + formatTime(currentRoom.host_timer), 'success');
        }
    } catch (e) {
        showStatus('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'error');
    }
}

function updateGuestTimer() {
    if (!currentRoom) return;
    document.getElementById('guestTimer').textContent = formatTime(currentRoom.host_timer || 0);
}

function formatTime(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    return h.toString().padStart(2, '0') + ':' + 
           m.toString().padStart(2, '0') + ':' + 
           s.toString().padStart(2, '0');
}

// –£—Ç–∏–ª–∏—Ç—ã
function copyLink() {
    if (!currentRoom) return;
    const link = window.location.origin + window.location.pathname + '?room=' + currentRoom.id;
    navigator.clipboard.writeText(link);
    showStatus('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞', 'success');
}

function leaveRoom() {
    if (timerInterval) clearInterval(timerInterval);
    
    document.getElementById('mainScreen').classList.remove('hidden');
    document.getElementById('roomScreen').classList.add('hidden');
    document.getElementById('videoFrame').src = '';
    
    currentRoom = null;
    isHost = false;
}

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –≥–æ—Å—Ç–µ–π
setInterval(async () => {
    if (!isHost && currentRoom) {
        try {
            const response = await fetch(API_URL + '/api/room/' + currentRoom.id);
            const data = await response.json();
            if (data.success) {
                currentRoom = data.room;
                updateGuestTimer();
            }
        } catch (e) {}
    }
}, 2000);

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å URL
window.onload = function() {
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('room');
    if (roomId) {
        document.getElementById('roomIdInput').value = roomId;
        showStatus('–ù–∞–π–¥–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–º–Ω–∞—Ç—É. –í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è"', 'success');
    }
};
</script>

</body>
</html>